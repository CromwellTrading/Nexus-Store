<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Store</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        .script-status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 10000;
            font-family: monospace;
            font-size: 14px;
            width: 500px;
            max-height: 400px;
            overflow: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        }
        
        .script-status h3 {
            margin-top: 0;
            color: #4fc3f7;
            border-bottom: 1px solid #444;
            padding-bottom: 8px;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 6px;
            border-left: 3px solid #4fc3f7;
            background: rgba(255,255,255,0.05);
        }
        
        .log-error {
            border-left-color: #f44336;
            color: #f44336;
        }
        
        .log-warning {
            border-left-color: #ff9800;
            color: #ff9800;
        }
        
        .log-success {
            border-left-color: #4caf50;
            color: #4caf50;
        }
        
        .log-debug {
            border-left-color: #9c27b0;
        }
        
        .debug-controls {
            margin: 10px 0;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }
        
        .debug-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 12px;
        }
        
        .debug-btn:hover {
            background: #0d8aee;
        }
        
        #admin-button.admin-active {
            background-color: #4caf50;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }
        
        .admin-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #4caf50;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 10000;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Indicador de modo administrador -->
    <div id="admin-indicator" class="admin-indicator">
        <i class="fas fa-user-shield"></i> Modo Administrador
    </div>
    
    <div class="container">
        <div class="tabs">
            <button class="tab-button active" data-tab="fisico">Físico</button>
            <button class="tab-button" data-tab="digital">Digital</button>
        </div>
        
        <div class="main-content">
            <div class="header">
                <div class="store-info">
                    <img src="https://ik.imagekit.io/tzsnnmyff/SAVE_20250717_091758.jpg?updatedAt=1752758478013" 
                         alt="Nexus Store" 
                         class="store-logo">
                </div>
                <div class="header-icons">
                    <button class="icon-button" id="cart-button"><i class="fas fa-shopping-cart"></i></button>
                    <button class="icon-button" id="profile-button"><i class="fas fa-user"></i></button>
                    <button class="icon-button" id="orders-button"><i class="fas fa-clipboard-list"></i></button>
                    <button class="icon-button" id="theme-button"><i class="fas fa-palette"></i></button>
                    <button class="icon-button" id="admin-button" style="display: none;">
                        <i class="fas fa-user-cog"></i>
                    </button>
                    <div class="theme-selector" id="theme-selector">
                        <div class="theme-option theme-light" data-theme="light"></div>
                        <div class="theme-option theme-dark" data-theme="dark"></div>
                        <div class="theme-option theme-red" data-theme="red"></div>
                        <div class="theme-option theme-blue" data-theme="blue"></div>
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <div class="view-controls">
                    <button class="view-button active" data-view="list"><i class="fas fa-list"></i> Lista</button>
                    <button class="view-button" data-view="columns"><i class="fas fa-columns"></i> Columnas</button>
                    <button class="view-button" data-view="grid"><i class="fas fa-th-large"></i> Mosaicos</button>
                </div>
                <div class="search-filter">
                    <input type="text" id="search-input" placeholder="Buscar productos...">
                    <select id="category-filter">
                        <option value="all">Todas las categorías</option>
                    </select>
                </div>
            </div>
            
            <div class="products-container">
                <div class="product-list" id="list-view"></div>
                <div class="product-columns" id="columns-view" style="display: none;"></div>
                <div class="product-grid" id="grid-view" style="display: none;"></div>
            </div>
        </div>
    </div>
    
    <div id="product-modal" style="display: none;"></div>
    
    <!-- Panel de diagnóstico mejorado -->
    <div id="script-status" class="script-status">
        <h3>Depuración de Nexus Store</h3>
        <div class="debug-controls">
            <button class="debug-btn" id="refresh-logs">Actualizar</button>
            <button class="debug-btn" id="clear-logs">Limpiar</button>
            <button class="debug-btn" id="force-admin">Forzar Admin</button>
            <button class="debug-btn" id="test-api">Probar API</button>
            <button class="debug-btn" id="toggle-logs">Ocultar</button>
        </div>
        <div id="status-content"></div>
    </div>

    <!-- Configuración global -->
    <script>
        // Configuración global - Asegúrate de actualizar esta URL con tu backend en Render
        window.API_BASE_URL = 'https://nexus-store-86r8.onrender.com/';
        
        // Variable global para estado de admin
        window.ADMIN_IDS = [];
        
        // Sistema de logging avanzado
        const LogSystem = {
            logs: [],
            visible: true,
            
            addLog: function(message, type = 'info') {
                const logEntry = {
                    timestamp: new Date().toLocaleTimeString(),
                    message: message,
                    type: type
                };
                
                this.logs.push(logEntry);
                this.renderLogs();
                
                // Registrar en consola
                const consoleMethod = type === 'error' ? 'error' : 
                                     type === 'warning' ? 'warn' : 'log';
                console[consoleMethod](`[${logEntry.timestamp}] ${message}`);
            },
            
            renderLogs: function() {
                const container = document.getElementById('status-content');
                if (!container) return;
                
                let html = '';
                this.logs.forEach(log => {
                    html += `
                        <div class="log-entry log-${log.type}">
                            <strong>[${log.timestamp}]</strong> ${log.message}
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                container.scrollTop = container.scrollHeight;
            },
            
            clearLogs: function() {
                this.logs = [];
                this.renderLogs();
            },
            
            toggleVisibility: function() {
                this.visible = !this.visible;
                const panel = document.getElementById('script-status');
                panel.style.display = this.visible ? 'block' : 'none';
            }
        };
        
        // Función global para fácil acceso
        window.addDebugLog = LogSystem.addLog.bind(LogSystem);
    </script>

    <!-- Scripts en el orden CORRECTO -->
    <script src="/js/notifications.js"></script>
    <script src="/js/themes.js"></script>
    <script src="/js/tabs.js"></script>
    <script src="/js/userProfile.js"></script>
    <script src="/js/productView.js"></script>
    <script src="/js/productModal.js"></script>
    <script src="/js/cart.js"></script>
    <script src="/js/searchFilter.js"></script>
    <script src="/js/orders.js"></script>
    <script src="/js/checkout.js"></script>
    <script src="/js/admin.js"></script>
    <script src="/js/main.js"></script>
    
    <!-- Script de inicialización del sistema de depuración -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Registrar eventos de los controles de depuración
            document.getElementById('refresh-logs').addEventListener('click', () => {
                LogSystem.renderLogs();
                addDebugLog('Logs actualizados manualmente', 'debug');
            });
            
            document.getElementById('clear-logs').addEventListener('click', () => {
                LogSystem.clearLogs();
                addDebugLog('Logs limpiados', 'success');
            });
            
            document.getElementById('force-admin').addEventListener('click', () => {
                addDebugLog('Forzando modo administrador...', 'warning');
                if (window.AdminSystem) {
                    window.AdminSystem.isAdmin = true;
                    window.AdminSystem.initializeAdmin();
                    addDebugLog('Modo administrador forzado. Botón debería ser visible.', 'success');
                    
                    // Destacar visualmente el botón de admin
                    const adminButton = document.getElementById('admin-button');
                    if (adminButton) {
                        adminButton.style.display = 'block';
                        adminButton.classList.add('admin-active');
                    }
                    
                    // Mostrar indicador de admin
                    const indicator = document.getElementById('admin-indicator');
                    if (indicator) {
                        indicator.style.display = 'block';
                    }
                } else {
                    addDebugLog('Error: AdminSystem no está definido', 'error');
                }
            });
            
            document.getElementById('test-api').addEventListener('click', async () => {
                addDebugLog('Probando conexión con API...', 'info');
                
                try {
                    const response = await fetch(`${window.API_BASE_URL}/api/admin/health`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    addDebugLog(`✅ API respondió correctamente. Estado: ${data.status}`, 'success');
                    
                    // Probar también los admin IDs
                    const idsResponse = await fetch(`${window.API_BASE_URL}/api/admin/ids`);
                    if (!idsResponse.ok) {
                        throw new Error(`HTTP ${idsResponse.status} en admin/ids`);
                    }
                    
                    const idsData = await idsResponse.json();
                    addDebugLog(`✅ IDs de admin obtenidos: ${idsData.join(', ')}`, 'success');
                } catch (error) {
                    addDebugLog(`❌ Error conectando a API: ${error.message}`, 'error');
                }
            });
            
            document.getElementById('toggle-logs').addEventListener('click', () => {
                LogSystem.toggleVisibility();
                document.getElementById('toggle-logs').textContent = 
                    LogSystem.visible ? 'Ocultar' : 'Mostrar';
            });
            
            // Mensaje inicial
            addDebugLog('Sistema de depuración inicializado', 'success');
            addDebugLog(`URL actual: ${window.location.href}`, 'info');
            addDebugLog(`Parámetros URL: ${window.location.search}`, 'info');
            addDebugLog(`API_BASE_URL: ${window.API_BASE_URL}`, 'info');
            
            // Verificar si hay un ID de Telegram en la URL
            const urlParams = new URLSearchParams(window.location.search);
            const tgid = urlParams.get('tgid');
            if (tgid) {
                addDebugLog(`ID de Telegram detectado en URL: ${tgid}`, 'info');
                localStorage.setItem('telegramUserId', tgid);
            } else {
                const savedId = localStorage.getItem('telegramUserId');
                if (savedId) {
                    addDebugLog(`ID de Telegram encontrado en localStorage: ${savedId}`, 'info');
                } else {
                    addDebugLog('No se detectó ID de Telegram', 'warning');
                }
            }
            
            // Verificar conexión con el backend
            setTimeout(async () => {
                addDebugLog('Verificando estado del backend...', 'debug');
                try {
                    const response = await fetch(`${window.API_BASE_URL}/api/admin/health`);
                    if (response.ok) {
                        const data = await response.json();
                        addDebugLog(`✅ Backend conectado: ${data.status}`, 'success');
                    } else {
                        addDebugLog(`⚠️ Backend respondió con estado: ${response.status}`, 'warning');
                    }
                } catch (error) {
                    addDebugLog(`❌ Error conectando al backend: ${error.message}`, 'error');
                }
            }, 1000);
        });
    </script>
</body>
</html>
